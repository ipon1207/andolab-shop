# データベース作業ガイド (Drizzle ORM)

このドキュメントは、このプロジェクトにおけるデータベース関連のすべての作業手順をまとめたものです。
データベースはアプリケーションの心臓部であり、チーム全員が同じ手順で安全に操作することが非常に重要です。作業を始める前に、必ずこのガイドに目を通してください。

## 📚 目次

- [🌟 黄金律：`schema.ts`が唯一の正解](#-黄金律schematsが唯一の正解)
- [📂 主要なファイルとディレクトリ](#-主要なファイルとディレクトリ)
- [シナリオ別・コマンド実行ガイド](#シナリオ別コマンド実行ガイド)
    - [【シナリオ1】テーブルやカラムの構造を変更したい (最も一般的な作業)](#シナリオ1テーブルやカラムの構造を変更したい-最も一般的な作業)
    - [【シナリオ2】開発用DBをリセットし、初期データを入れたい](#シナリオ2開発用dbをリセットし初期データを入れたい)
    - [【シナリオ3】他の人のDB変更を自分の環境に反映させたい](#シナリオ3他の人のdb変更を自分の環境に反映させたい)
- [🛠️ GUIツール (Drizzle Studio) の使い方](#️-guiツール-drizzle-studio-の使い方)
- [📜 コマンド クイックリファレンス](#-コマンド-クイックリファレンス)

---

## 🌟 黄金律：`schema.ts`が唯一の正解

Drizzle ORMを使った開発における、最も重要なルールです。

> **データベースの構造（テーブルやカラム）の「正解」は、常に `packages/db-schema/src/schema.ts` ファイルです。**

`sqlite.db`ファイルを直接編集したり、Drizzle Studioでテーブル構造を変更することは**絶対に禁止**です。必ず`schema.ts`ファイルを編集し、それをコマンドでデータベースに反映させる、という一方向の流れを徹底してください。

## 📂 主要なファイルとディレクトリ

- **`packages/db-schema/src/schema.ts`**
    - すべてのテーブル、カラム、リレーションを定義するファイル。データベースの設計図です。

- **`packages/db-schema/src/index.ts`**
    - データベースへの接続（`db`インスタンス）を定義し、`schema.ts`の内容を再エクスポートする、パッケージの窓口です。

- **`packages/db-schema/drizzle/`**
    - `schema.ts`の変更履歴を記録する「マイグレーションファイル」が保存されるディレクトリ。このディレクトリ内のファイルも、`schema.ts`と同様にGitで管理する重要なソースコードです。

---

## シナリオ別・コマンド実行ガイド

### 【シナリオ1】テーブルやカラムの構造を変更したい (最も一般的な作業)

1.  **`schema.ts`を編集する**
    `packages/db-schema/src/schema.ts`を開き、テーブル定義を自由に変更します。（例: `users`テーブルに`age`カラムを追加）

2.  **マイグレーションファイルを「生成」する**
    `schema.ts`の変更内容と現在のDB状態を比較し、差分を埋めるためのSQLが記述されたマイグレーションファイルを自動生成します。

    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:generate
    ```

    成功すると、`packages/db-schema/drizzle/`に新しい`.sql`ファイルが作成されます。

3.  **マイグレーションを「適用」する**
    新しく生成されたマイグレーションファイルを、実際にデータベースに対して実行します。

    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:migrate
    ```

4.  **変更をコミットする**
    ⚠️ **重要:** 以下の**両方**の変更を、必ずGitにコミットしてください。
    - 変更した `packages/db-schema/src/schema.ts`
    - 新しく生成された `packages/db-schema/drizzle/〇〇.sql` ファイル

### 【シナリオ2】開発用DBをリセットし、初期データを入れたい

開発中にデータがぐちゃぐちゃになり、一度まっさらな状態からやり直したい時の手順です。

1.  **データベースファイルを削除する**
    `packages/db-schema/`ディレクトリにある`sqlite.db`ファイルを、手動で削除します。

2.  **マイグレーションを「適用」する**
    `sqlite.db`ファイルがない状態でこのコマンドを実行すると、Drizzleはすべてのマイグレーションファイルを最初から実行し、最新の状態のデータベースを再作成します。

    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:migrate
    ```

3.  **初期データを「投入」する (Seeding)**
    `seed`スクリプトを実行して、開発用のテストユーザーなどを投入します。
    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:seed
    ```
    これで、完全にクリーンな初期状態のデータベースが手に入ります。

### 【シナリオ3】他の人のDB変更を自分の環境に反映させたい

チームの他のメンバーがDB構造を変更し、そのコミットをあなたが`git pull`した時の手順です。

1.  **`git pull`で最新のコードを取得します。**

2.  **マイグレーションを「適用」する**
    Drizzleが、あなたのローカルDBにまだ適用されていないマイグレーションファイルだけを賢く見つけ出し、実行してくれます。
    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:migrate
    ```
    これだけで、あなたのローカルDBもチームの最新の状態に更新されます。

---

## 🛠️ GUIツール (Drizzle Studio) の使い方

Drizzle Studioは、Webブラウザ上でデータベースの中身を直接、GUIで確認・編集できる非常に便利な開発ツールです。

1.  **Drizzle Studioを起動する**

    ```bash
    # プロジェクトのルートディレクトリで実行
    npm run db:studio
    ```

2.  **ブラウザでアクセスする**
    ターミナルに表示されたURL（通常は `http://localhost:5000`）を開きます。

3.  **データの閲覧・編集**
    テーブル一覧からテーブルを選択し、中のデータを閲覧・追加・編集・削除できます。APIのテスト前に手動でデータを用意したい場合などに非常に役立ちます。

> 🚨 **警告**
> Drizzle Studioは、開発を補助するためのツールです。データベースに直接、生の変更を加えることができるため、**本番環境のデータベースに対しては絶対に実行しないでください。**

---

## 📜 コマンド クイックリファレンス

| コマンド              | 主な目的                                                | いつ使うか                                                                                                            |
| :-------------------- | :------------------------------------------------------ | :-------------------------------------------------------------------------------------------------------------------- |
| `npm run db:generate` | `schema.ts`の変更から**マイグレーションファイルを生成** | **自分が**テーブルやカラムの構造を変更した時。（`db:migrate`の前に実行）                                              |
| `npm run db:migrate`  | **マイグレーションファイルをデータベースに適用**        | **自分が**構造を変更した時（`db:generate`の後）、または**他の人**のDB変更を`git pull`した時。DBのリセット時にも使用。 |
| `npm run db:seed`     | **開発用の初期データを投入**（DBリセット）              | 開発用のDBをまっさらにして、初期データを入れたい時。                                                                  |
| `npm run db:studio`   | **GUIのデータベースブラウザを起動**                     | 開発中にデータベースの中身を確認・編集したい時。                                                                      |
